<!DOCTYPE html>
<html>
<head>
    <title>Mirror Favicons</title>
    <link rel="stylesheet" href="/static/default.css">
    <link rel="stylesheet" href="/static/mirror.css">
    <script>
        function addOverride(faviconHref, pageUrl, formId) {
            const form = document.getElementById(formId);
            const scope = form.querySelector('input[name="scope"]:checked').value;
            const messageEl = form.querySelector('.override-message');
            const button = form.querySelector('button');
            
            button.disabled = true;
            messageEl.textContent = 'Adding override...';
            messageEl.className = 'override-success';
            
            fetch('/add-favicon-override', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    favicon_url: faviconHref,
                    page_url: pageUrl,
                    scope: scope
                })
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.success) {
                    messageEl.textContent = '✓ Override added: ' + data.cache_key;
                    messageEl.className = 'override-success';
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    messageEl.textContent = '✗ Error: ' + data.error;
                    messageEl.className = 'override-error';
                    button.disabled = false;
                }
            })
            .catch(err => {
                messageEl.textContent = '✗ Error: ' + err.message;
                messageEl.className = 'override-error';
                button.disabled = false;
            });
        }
    </script>
</head>
<body>
    <h1>Favicon Browser</h1>
    
    <div class="cache-panel">
        <h2>Three-Tier Cache System</h2>
        <p>Favicons are searched in order of precedence (highest to lowest):</p>
        <div class="cache-file-list">
            {% for key in ['overrides', 'defaults', 'discovered'] %}
            {% set cache = cache_files[key] %}
            <div class="cache-file-item precedence-{{ cache.precedence }}">
                <div class="cache-file-name">
                    {{ cache.precedence }}. {{ cache.name }}
                    <span class="cache-badge cache-{{ key }}">{{ cache.count }} entries</span>
                </div>
                <div class="cache-file-path">{{ cache.path }}</div>
                <div class="cache-file-stats">
                    {% if cache.precedence == 1 %}
                        Manual overrides - highest priority, editable via this UI or directly
                    {% elif cache.precedence == 2 %}
                        App defaults - curated favicons distributed with the app
                    {% else %}
                        Auto-discovered - favicons cached on first use
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
            <strong>Current URL:</strong> {{ url|e }}
        </p>
    </div>
    
    <h2>Available Favicons (sorted by preference)</h2>
    {% for f in favicons %}
    <div class="favicon-entry{% if f.image_type == 'invalid' %} invalid{% endif %}">
        <p>
            <a href="{{ f.href }}">{{ f.href|e }}</a>
            
            {% if f.cache_source.file %}
                {% if f.cache_source.file == 'override' %}
                    <span class="cache-badge cache-override">OVERRIDE</span>
                {% elif f.cache_source.file == 'default' %}
                    <span class="cache-badge cache-default">DEFAULT</span>
                {% elif f.cache_source.file == 'discovered' %}
                    <span class="cache-badge cache-discovered">DISCOVERED</span>
                {% endif %}
                <span class="cache-key-info">cached as: {{ f.cache_source.cache_key }}</span>
            {% else %}
                <span class="cache-badge cache-none">NOT CACHED</span>
            {% endif %}
            
            {% if f.image_type == 'invalid' %}
                <span class="cache-badge cache-invalid">INVALID - FAILED TO LOAD</span>
            {% endif %}
        </p>
        
        {% if f.href != f.resolved_href %}
        <p>Resolves to: <a href="{{ f.resolved_href }}">{{ f.resolved_href|e }}</a></p>
        {% endif %}
        
        <p>Image Type: {{ f.image_type }} | Size: {{ f.width }}x{{ f.height }}</p>
        
        {% if f.image_type != 'invalid' %}
        <p>
            <img src="{{ f.href }}" width="20" alt="20x20 preview" /> 20x20 preview
        </p>
        <p>
            <img src="{{ f.href }}" alt="Full size"/> Full size ({{ f.width }}x{{ f.height }})
        </p>
        {% else %}
        <p><em>Image failed to load - URL may be broken or inaccessible</em></p>
        {% endif %}
        
        {% if not f.cache_source.file or f.cache_source.file != 'override' %}
        <div class="override-form" id="form-{{ loop.index }}">
            <strong>Add Override:</strong>
            <label>
                <input type="radio" name="scope" value="domain" checked>
                Domain only ({{ url.split('/')[2].split('.')[-2:] | join('.') }})
            </label>
            {% if url.split('/')|length > 3 and url.split('/')[3] %}
            <label>
                <input type="radio" name="scope" value="path">
                Domain + first path ({{ url.split('/')[2] }}/{{ url.split('/')[3] }})
            </label>
            {% endif %}
            <button onclick="addOverride('{{ f.href|e }}', '{{ url|e }}', 'form-{{ loop.index }}')">
                Add to Overrides
            </button>
            <div class="override-message"></div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</body>
</html>
