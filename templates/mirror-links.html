<!DOCTYPE html>
<html>
<head>
    <title>Mirror Links</title>
    <link rel="stylesheet" href="/static/default.css">
    <link rel="stylesheet" href="/static/mirror.css">
</head>
<body>
    <h1>Mirror Links</h1>
    
    <div class="metadata-panel">
        <h2>Links</h2>
        <div class="url-list">
            <div class="url-item" style="flex-direction: column; align-items: flex-start;">
                <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                    <input type="radio" name="link_variant" value="default" checked>
                    <button class="copy-btn" id="default-link-copy">Copy</button>
                    <span style="min-width: 100px;"><strong>Default</strong></span>
                    <span id="default-link-display"></span>
                </div>
                <div style="margin-left: 140px; color: #666; font-family: monospace; font-size: 0.9em; margin-top: 4px;" id="default-link-html"></div>
            </div>
            <div class="url-item" style="flex-direction: column; align-items: flex-start;">
                <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                    <input type="radio" name="link_variant" value="custom">
                    <button class="copy-btn" id="custom-link-copy">Copy</button>
                    <span style="min-width: 100px;"><strong>Custom</strong></span>
                    <span id="custom-link-display"></span>
                </div>
                <div style="margin-left: 140px; color: #666; font-family: monospace; font-size: 0.9em; margin-top: 4px;" id="custom-link-html"></div>
            </div>
        </div>
    </div>
    
    <div class="metadata-panel">
        <h2>Title</h2>
        <div class="url-list">
            {% for variant in title_variants %}
                <div class="url-item"{% if variant.is_duplicate %} style="opacity: 0.6; background-color: #f5f5f5;"{% endif %}>
                    <input type="radio" name="title_variant" value="title{{ loop.index0 }}" data-text="{{ variant.value|e }}" {% if loop.first %}checked{% endif %}>
                    <button class="copy-btn" data-html="{{ variant.value|e }}">Copy</button>
                    <span style="min-width: 100px;"><strong>{{ variant.label }}</strong></span>
                    <span>{{ variant.value|e }}</span>
                </div>
            {% endfor %}
        </div>
    </div>
    
    {% if fragment %}
    <div class="metadata-panel">
        <h2>Fragment</h2>
        <div class="url-list">
            <div class="url-item">
                <input type="radio" name="fragment_variant" value="none" data-text="" checked>
                <span style="min-width: 100px;"><strong>None</strong></span>
            </div>
            <div class="url-item">
                <input type="radio" name="fragment_variant" value="fragment" data-text="{{ fragment|e }}">
                <button class="copy-btn" data-html="{{ fragment|e }}">Copy</button>
                <span style="min-width: 100px;"><strong>Fragment</strong></span>
                <span>{{ fragment|e }}</span>
            </div>
            <div class="url-item">
                <input type="radio" name="fragment_variant" value="fragment_text" data-text="{{ fragment_text|e }}">
                <button class="copy-btn" data-html="{{ fragment_text|e }}">Copy</button>
                <span style="min-width: 100px;"><strong>Fragment Text</strong></span>
                <span>{{ fragment_text|e }}</span>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="metadata-panel">
        <h2>URL</h2>
        <div class="url-list">
            {% for variant in url_variants %}
                <div class="url-item"{% if variant.is_duplicate %} style="opacity: 0.6; background-color: #f5f5f5;"{% endif %}>
                    <input type="radio" name="url_variant" value="url{{ loop.index0 }}" data-text="{{ variant.url|e }}" {% if loop.first %}checked{% endif %}>
                    <button class="copy-btn" data-html="{{ variant.url|e }}">Copy</button>
                    <span style="min-width: 100px;"><strong>{{ variant.label }}</strong></span>
                    <span><a href="{{ variant.url }}">{{ variant.url|e }}</a></span>
                </div>
            {% endfor %}
        </div>
    </div>
    
    {% if favicon %}
    <div class="favicon-section">
        <h2>Favicon</h2>
        <div class="favicon-display">
            <input type="checkbox" id="include_favicon" checked>
            <img src="{{ favicon }}" width="20" alt="Favicon" data-url="{{ favicon|e }}" />
            <button class="copy-btn" data-html="{{ favicon|e }}">Copy</button>
            <a href="{{ favicon }}">{{ favicon|e }}</a>
        </div>
    </div>
    {% endif %}

    <div class="metadata-panel">
        <h2>Metadata</h2>
        {% if html_size %}
        <div class="metadata-item">
            <strong>HTML Size:</strong> {{ "{:,}".format(html_size) }} bytes
        </div>
        {% endif %}
        {% if content_type %}
        <div class="metadata-item">
            <strong>Content-Type:</strong> {{ content_type|e }}
        </div>
        {% endif %}
        {% if user_agent %}
        <div class="metadata-item">
            <strong>User Agent:</strong> {{ user_agent|e }}
        </div>
        {% endif %}
        {% if cookie_string %}
        <div class="metadata-item">
            <strong>Cookie String:</strong> {{ cookie_string|e }}
        </div>
        {% endif %}
        {% if clipboard_error %}
        <div class="metadata-item">
            <strong>Clipboard Error:</strong> {{ clipboard_error|e }}
        </div>
        {% endif %}
    </div>

    <script>
        // Store default values
        const defaultValues = {
            title: '{{ title_variants[0].value|e }}',
            fragmentText: {% if fragment %}'{{ fragment_text|e }}'{% else %}''{% endif %},
            url: '{{ url_variants[0].url|e }}',
            favicon: {% if favicon %}'{{ favicon|e }}'{% else %}null{% endif %}
        };

        // Function to escape HTML for display
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Function to build a link
        function buildLink(title, fragmentText, url, includeFavicon) {
            let html = '';
            
            // Add favicon if requested
            if (includeFavicon && defaultValues.favicon) {
                html += `<img src="${escapeHtml(defaultValues.favicon)}" width="20" alt="Favicon" /> `;
            }
            
            // Add link with appropriate text
            const linkText = fragmentText ? `${fragmentText} - ${title}` : title;
            html += `<a target="_blank" href="${escapeHtml(url)}">${escapeHtml(linkText)}</a>`;
            
            return html;
        }

        // Function to update links
        function updateLinks() {
            // Build default link (always uses original values)
            const defaultLink = buildLink(
                defaultValues.title,
                defaultValues.fragmentText,
                defaultValues.url,
                true // always include favicon for default
            );
            
            // Display default link
            document.getElementById('default-link-display').innerHTML = defaultLink;
            document.getElementById('default-link-html').textContent = defaultLink;
            document.getElementById('default-link-copy').dataset.html = defaultLink;
            
            // Build custom link from selections
            const titleRadio = document.querySelector('input[name="title_variant"]:checked');
            const title = titleRadio ? titleRadio.dataset.text : defaultValues.title;
            
            const fragmentRadio = document.querySelector('input[name="fragment_variant"]:checked');
            const fragmentText = fragmentRadio ? fragmentRadio.dataset.text : '';
            
            const urlRadio = document.querySelector('input[name="url_variant"]:checked');
            const url = urlRadio ? urlRadio.dataset.text : defaultValues.url;
            
            const faviconCheckbox = document.getElementById('include_favicon');
            const includeFavicon = faviconCheckbox ? faviconCheckbox.checked : false;
            
            const customLink = buildLink(title, fragmentText, url, includeFavicon);
            
            // Display custom link
            document.getElementById('custom-link-display').innerHTML = customLink;
            document.getElementById('custom-link-html').textContent = customLink;
            document.getElementById('custom-link-copy').dataset.html = customLink;
            
            // Auto-copy custom link when selections change
            if (linksInitialized) {
                navigator.clipboard.writeText(customLink).then(() => {
                    console.log('Custom link copied to clipboard');
                });
            }
        }

        // Function to show tooltip
        function showTooltip(btn, message) {
            const tooltip = document.createElement('span');
            tooltip.textContent = message;
            tooltip.style.cssText = 'position: absolute; background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; z-index: 1000; pointer-events: none;';
            
            const rect = btn.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - 30) + 'px';
            
            document.body.appendChild(tooltip);
            
            setTimeout(() => {
                tooltip.remove();
            }, 1500);
        }

        // Function to attach copy button listeners
        function attachCopyListeners() {
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.html) {
                        navigator.clipboard.writeText(btn.dataset.html).then(() => {
                            console.log('HTML copied to clipboard');
                            showTooltip(btn, 'Copied!');
                        });
                    }
                });
            });
        }

        // Track initialization
        let linksInitialized = false;

        // Attach listeners on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Build initial links
            updateLinks();
            
            // Attach copy listeners
            attachCopyListeners();
            
            // Auto-copy default link on page load
            setTimeout(() => {
                const defaultLink = document.getElementById('default-link-copy').dataset.html;
                if (defaultLink) {
                    navigator.clipboard.writeText(defaultLink).then(() => {
                        console.log('Default link copied to clipboard');
                        linksInitialized = true;
                    });
                }
            }, 100);
            
            // Listen for changes to update custom link
            document.querySelectorAll('input[type="radio"]:not([name="link_variant"]), input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', updateLinks);
            });
        });
    </script>
</body>
</html>
